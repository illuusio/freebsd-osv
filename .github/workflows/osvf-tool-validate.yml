---
name: Validate OSVF files with osvf-tool

on:
  workflow_call:
    inputs:
      container:
        required: true
        type: string

jobs:
  validate-osvf:
    runs-on: ubuntu-latest
    container: ${{ inputs.container }}

    env:
      DEBIAN_FRONTEND: noninteractive
      TZ: Etc/GMT

    steps:
      - uses: actions/checkout@v4
      - name: Link correct timezone to '/etc/localtime'
        run: ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
      - name: Enable automatic restarts from maint scripts
        run : sed -i "s/101/0/g" -i /usr/sbin/policy-rc.d
      - name: Fake /sbin/runlevel to avoid warnings of could not determine current runlevel
        run: echo -e '#!/bin/sh\necho "N 5"' > /sbin/runlevel; chmod +x /sbin/runlevel
      - name: Emit non-zero exit code also on warnings
        run: echo 'APT::Update::Error-Mode "any";' > /etc/apt/apt.conf.d/non-zero-exit-on-warnings
      - name: Run 'apt update'
        run: apt update -qq
      - name: Install package 'lua5.4' 'jq'
        run: apt install -y autoconf automake curl git jq liblua5.4-dev libtool lua5.4 make python3-lxml python3-pypandoc wget xz-utils
      - name: Build libUCL (Universal configuration library parser)
        run: |
             wget https://github.com/vstakhov/libucl/archive/refs/tags/0.9.2.tar.gz
             tar xvf 0.9.2.tar.gz
             cd libucl-0.9.2
             ./autogen.sh
             ./configure --prefix=/usr --enable-lua
             make install
      - name: Run validation
        run: |
             LUA_PATH="${GITHUB_WORKSPACE}/lua/?.lua;;" lua5.4 bin/osvf-tool.lua merge > test.json
      - name: Validate output with jq
        run: cat test.json | jq -c > /dev/null
      - name: Validate all files with Makefile
        run: LUA_CMD=/usr/bin/lua5.4 make validate
      - name: Check that there is not new entries on VuXML
        run: |
             MDFILE=$(find vuln -type f | sed -e "s#\.json\$#\.md#" -e "s#vuln/#md/#" | sort -u -r)
             MISSING=0
             for file in ${MDFILE}; do
                 if [ ! -f "${file}" ]; then
                     echo "Missing Markdown file: '${file}'"
                     MISSING=1
                 fi
             done
             if [ ${MISSING} -eq 1 ]; then
                exit 1
             fi
             exit 0

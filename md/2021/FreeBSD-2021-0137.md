# FreeBSD-kernel -- SMAP bypass
# Problem Description:

The FreeBSD kernel enables SMAP during boot when the CPU reports that
the SMAP capability is present. Subroutines such as copyin() and
copyout() are responsible for disabling SMAP around the sections of code
that perform user memory accesses.

Such subroutines must handle page faults triggered when user memory is
not mapped. The kernel\'s page fault handler checks the validity of the
fault, and if it is indeed valid it will map a page and resume copying.
If the fault is invalid, the fault handler returns control to a
trampoline which aborts the operation and causes an error to be
returned. In this second scenario, a bug in the implementation of SMAP
support meant that SMAP would remain disabled until the thread returns
to user mode.

# Impact:

This bug may be used to bypass the protections provided by SMAP for the
duration of a system call. It could thus be combined with other kernel
bugs to craft an exploit.


## Affected packages
 - **FreeBSD-kernel**
    - **Introduced:** 13.0
    - **Fixed:** 13.0_1
    - **Introduced:** 12.2
    - **Fixed:** 12.2_7

## Details
 - **published**: 2021-05-27T00:00:00Z
 - **modified**: 2021-05-27T00:00:00Z
 - **discovery**: 2021-05-27T00:00:00Z
 - **vid**: [d1ac6a6a-bea8-11eb-b87a-901b0ef719ab](https://vuxml.freebsd.org/freebsd/d1ac6a6a-bea8-11eb-b87a-901b0ef719ab.html)

## References
 - ADVISORY: [https://api.osv.dev/v1/vulns/CVE-2021-29628](https://api.osv.dev/v1/vulns/CVE-2021-29628)
 - ADVISORY: [https://www.freebsd.org/security/advisories/FreeBSD-SA-21:11.smap.asc](https://www.freebsd.org/security/advisories/FreeBSD-SA-21:11.smap.asc)

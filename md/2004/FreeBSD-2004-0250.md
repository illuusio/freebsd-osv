# Cyrus IMAPd -- APPEND command uses undefined programming construct
To support MULTIAPPENDS the cmd_append handler uses the global stage
array. This array is one of the things that gets destructed when the
fatal() function is triggered. When the Cyrus IMAP code adds new entries
to this array this is done with the help of the postfix increment
operator in combination with memory allocation functions. The increment
is performed on a global variable counting the number of allocated
stages. Because the memory allocation function can fail and therefore
internally call fatal() this construct is undefined arcording to ANSI C.
This means that it is not clearly defined if the numstage counter is
already increased when fatal() is called or not. While older gcc
versions increase the counter after the memory allocation function has
returned, on newer gcc versions (3.x) the counter gets actually
increased before. In such a case the stage destructing process will try
to free an uninitialised and maybe attacker supplied pointer. Which
again could lead to remote code execution. (Because it is hard for an
attacker to let the memory allocation functions fail in the right moment
no PoC code for this problem was designed)


## Affected packages
 - **cyrus-imapd**
    - **Introduced:** 2.2.7
    - **Fixed:** 2.2.8

## Details
 - **published**: 2004-11-22T00:00:00Z
 - **modified**: 2004-11-22T00:00:00Z
 - **discovery**: 2004-11-06T00:00:00Z
 - **vid**: [31952117-3d17-11d9-8818-008088034841](https://vuxml.freebsd.org/freebsd/31952117-3d17-11d9-8818-008088034841.html)

## References
 - WEB: [http://security.e-matters.de/advisories/152004.html](http://security.e-matters.de/advisories/152004.html)
